<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StyleHub - Moda Premium</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            color: #333;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 0;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }

        .logo {
            font-size: 2.5em;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .nav {
            display: flex;
            gap: 30px;
        }

        .nav a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            transition: opacity 0.3s ease;
        }

        .nav a:hover {
            opacity: 0.8;
        }

        .cart-icon {
            position: relative;
            cursor: pointer;
        }

        .cart-count {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ff4757;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        .container {
            max-width: 1200px;
            margin: 40px auto;
            padding: 0 20px;
        }

        .page-title {
            text-align: center;
            color: #333;
            margin-bottom: 40px;
            font-size: 2.5em;
            font-weight: 300;
        }

        .product-page {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 60px;
            margin-bottom: 50px;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .product-gallery {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .main-image {
            width: 100%;
            height: 500px;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .main-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .main-image:hover img {
            transform: scale(1.05);
        }

        .thumbnail-gallery {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .thumbnail {
            width: 100%;
            height: 80px;
            object-fit: cover;
            border-radius: 10px;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.3s ease;
            opacity: 0.7;
        }

        .thumbnail:hover {
            opacity: 1;
            border-color: #667eea;
        }

        .thumbnail.active {
            opacity: 1;
            border-color: #667eea;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .product-info {
            padding: 20px 0;
            position: relative;
        }

        .product-title {
            font-size: 2.5em;
            font-weight: 700;
            color: #333;
            margin-bottom: 15px;
            line-height: 1.2;
        }

        .product-price {
            font-size: 2.2em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 25px;
        }

        .product-description {
            color: #666;
            line-height: 1.7;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .product-description h3 {
            color: #333;
            margin: 20px 0 10px 0;
            font-size: 1.3em;
        }

        .product-description ul {
            margin: 15px 0;
            padding-left: 20px;
        }

        .product-description li {
            margin: 8px 0;
            color: #555;
        }

        .sizes-section {
            margin-bottom: 25px;
        }

        .sizes-label {
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            display: block;
            font-size: 1.1em;
        }

        .sizes {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .size-option {
            padding: 12px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            background: white;
            font-size: 1.1em;
        }

        .size-option:hover {
            border-color: #667eea;
            color: #667eea;
            transform: translateY(-2px);
        }

        .size-option.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .quantity-section {
            margin-bottom: 30px;
        }

        .quantity-label {
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            display: block;
            font-size: 1.1em;
        }

        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .quantity-btn {
            width: 40px;
            height: 40px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2em;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .quantity-btn:hover {
            border-color: #667eea;
            color: #667eea;
        }

        .quantity {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
            min-width: 30px;
            text-align: center;
        }

        .product-actions {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
        }

        .add-to-cart-btn, .buy-now-btn {
            flex: 1;
            padding: 18px;
            border: none;
            border-radius: 25px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .add-to-cart-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .add-to-cart-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(102, 126, 234, 0.4);
        }

        .buy-now-btn {
            background: linear-gradient(135deg, #2ed573 0%, #17a2b8 100%);
            color: white;
        }

        .buy-now-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(46, 213, 115, 0.4);
        }

        .product-features {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .feature {
            display: flex;
            align-items: center;
            gap: 12px;
            color: #555;
            font-size: 0.95em;
        }

        .feature-icon {
            font-size: 1.2em;
        }

        .badge {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #ff4757;
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .badge.new {
            background: #2ed573;
        }

        .badge.sale {
            background: #ff4757;
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
            }
            
            .nav {
                gap: 20px;
            }
            
            .product-page {
                grid-template-columns: 1fr;
                gap: 30px;
                padding: 20px;
            }
            
            .main-image {
                height: 400px;
            }
            
            .thumbnail-gallery {
                grid-template-columns: repeat(6, 1fr);
            }
            
            .thumbnail {
                height: 60px;
            }
            
            .product-title {
                font-size: 2em;
            }
            
            .product-actions {
                flex-direction: column;
            }
        }

        .loading {
            opacity: 0;
            animation: fadeIn 0.5s ease forwards;
        }

        @keyframes fadeIn {
            to {
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">StyleHub</div>
            <nav class="nav">
                <a href="#home">Inicio</a>
                <a href="#products">Productos</a>
                <a href="#about">Nosotros</a>
                <a href="#contact">Contacto</a>
            </nav>
            <div class="cart-icon">
                🛒
                <span class="cart-count" id="cartCount">0</span>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="product-page">
            <!-- Product Images Gallery -->
            <div class="product-gallery">
                <div class="main-image">
                    <img src="133826_1.webp" alt="Producto" id="mainImage" loading="lazy">
                </div>
                <div class="thumbnail-gallery">
                    <img src="133826_1.webp" alt="Vista 1" class="thumbnail active" onclick="changeMainImage('133826_1.webp')" loading="lazy">
                    <img src="133826_2.webp" alt="Vista 2" class="thumbnail" onclick="changeMainImage('133826_2.webp')" loading="lazy">
                    <img src="133826_3.webp" alt="Vista 3" class="thumbnail" onclick="changeMainImage('133826_3.webp')" loading="lazy">
                    <img src="133826_10.jpg" alt="Vista 4" class="thumbnail" onclick="changeMainImage('133826_10.jpg')" loading="lazy">
                    <img src="133826_10.webp" alt="Vista 5" class="thumbnail" onclick="changeMainImage('133826_10.webp')" loading="lazy">
                    <img src="133826_11.webp" alt="Vista 6" class="thumbnail" onclick="changeMainImage('133826_11.webp')" loading="lazy">
                </div>
            </div>

            <!-- Product Information -->
            <div class="product-info">
                <div class="badge new">NUEVO</div>
                <h1 class="product-title">Camiseta Premium StyleHub</h1>
                <div class="product-price">€29.99</div>
                
                <div class="product-description">
                    <p>Descubre nuestra camiseta premium, diseñada con los más altos estándares de calidad. Fabricada con algodón 100% orgánico, esta prenda combina comodidad y estilo en perfecta armonía.</p>
                    
                    <h3>Características:</h3>
                    <ul>
                        <li>✅ Algodón 100% orgánico certificado</li>
                        <li>✅ Corte moderno y cómodo</li>
                        <li>✅ Lavado a máquina seguro</li>
                        <li>✅ Colores que no se destiñen</li>
                        <li>✅ Tela transpirable y suave</li>
                    </ul>
                </div>

                <div class="sizes-section">
                    <label class="sizes-label">Selecciona tu talla:</label>
                    <div class="sizes">
                        <span class="size-option" data-size="S">S</span>
                        <span class="size-option selected" data-size="M">M</span>
                        <span class="size-option" data-size="L">L</span>
                        <span class="size-option" data-size="XL">XL</span>
                        <span class="size-option" data-size="XXL">XXL</span>
                    </div>
                </div>

                <div class="quantity-section">
                    <label class="quantity-label">Cantidad:</label>
                    <div class="quantity-controls">
                        <button class="quantity-btn" onclick="decreaseQuantity()">-</button>
                        <span class="quantity" id="quantity">1</span>
                        <button class="quantity-btn" onclick="increaseQuantity()">+</button>
                    </div>
                </div>

                <div class="product-actions">
                    <button class="add-to-cart-btn" onclick="addToCart()">
                        🛒 Añadir al Carrito
                    </button>
                    <button class="buy-now-btn" onclick="buyNow()">
                        💳 Comprar Ahora
                    </button>
                </div>

                <div class="product-features">
                    <div class="feature">
                        <span class="feature-icon">🚚</span>
                        <span>Envío gratis en pedidos +€50</span>
                    </div>
                    <div class="feature">
                        <span class="feature-icon">↩️</span>
                        <span>Devoluciones gratuitas</span>
                    </div>
                    <div class="feature">
                        <span class="feature-icon">🔒</span>
                        <span>Compra 100% segura</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let cartCount = 0;
        let cartItems = [];
        let quantity = 1;
        let selectedSize = 'M';

        // Add staggered loading animation
        document.addEventListener('DOMContentLoaded', function() {
            // Size selection functionality
            const sizeOptions = document.querySelectorAll('.size-option');
            sizeOptions.forEach(option => {
                option.addEventListener('click', function() {
                    // Remove selected class from siblings
                    const siblings = this.parentNode.querySelectorAll('.size-option');
                    siblings.forEach(sibling => sibling.classList.remove('selected'));
                    
                    // Add selected class to clicked option
                    this.classList.add('selected');
                    selectedSize = this.getAttribute('data-size');
                });
            });
        });

        function changeMainImage(imageSrc) {
            document.getElementById('mainImage').src = imageSrc;
            
            // Update active thumbnail
            const thumbnails = document.querySelectorAll('.thumbnail');
            thumbnails.forEach(thumb => thumb.classList.remove('active'));
            event.target.classList.add('active');
        }

        function increaseQuantity() {
            quantity++;
            document.getElementById('quantity').textContent = quantity;
        }

        function decreaseQuantity() {
            if (quantity > 1) {
                quantity--;
                document.getElementById('quantity').textContent = quantity;
            }
        }

        function addToCart() {
            const productName = 'Camiseta Premium StyleHub';
            const price = 29.99;
            
            for (let i = 0; i < quantity; i++) {
                cartCount++;
                cartItems.push({ 
                    name: `${productName} (Talla: ${selectedSize})`, 
                    price: price 
                });
            }
            
            // Update cart count display
            document.getElementById('cartCount').textContent = cartCount;
            
            // Show success message
            showNotification(`${quantity}x ${productName} (${selectedSize}) añadido al carrito`);
        }

        function buyNow() {
            addToCart();
            showNotification('Redirigiendo al checkout...');
            // Aquí normalmente redirigirías a la página de checkout
        }

        function showNotification(message) {
            // Create notification element
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #2ed573;
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                box-shadow: 0 5px 15px rgba(0,0,0,0.2);
                z-index: 1000;
                font-weight: 500;
                transform: translateX(100%);
                transition: transform 0.3s ease;
                max-width: 300px;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 100);
            
            // Remove after 4 seconds
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 4000);
        }

        // Cart icon click functionality
        document.querySelector('.cart-icon').addEventListener('click', function() {
            if (cartItems.length === 0) {
                showNotification('Tu carrito está vacío');
                return;
            }
            
            let cartSummary = 'Carrito de compras:\n\n';
            let total = 0;
            
            cartItems.forEach((item, index) => {
                cartSummary += `${index + 1}. ${item.name} - €${item.price}\n`;
                total += item.price;
            });
            
            cartSummary += `\nTotal: €${total.toFixed(2)}`;
            
            alert(cartSummary);
        });
    </script>

<!-- 
XSMLX Test Widget - SNIPPET PARA PROBAR CONEXIÓN
================================================

INSTRUCCIONES:
1. Copia TODO el código de abajo
2. Pégalo en tu página web (antes del </body>)
3. Cambia la URL del backend por la de Render
4. ¡Listo! El widget aparecerá automáticamente

CONFIGURACIÓN:
- Cambia 'https://xsmlx-backend.onrender.com' por tu URL de Render
- Este snippet solo prueba la conexión con el backend
-->

<script>
// XSMLX Virtual Try-On Widget CON REGISTRO - Snippet para insertar en cualquier web
(function() {
    'use strict';
    
    // CONFIGURACIÓN - Cambia esta URL por tu servidor
    const XSMLX_CONFIG = {
        backendUrl: 'https://tinedaropa.vercel.app',
        widgetId: 'xsmlx-widget-' + Math.random().toString(36).substr(2, 9),
        currentPageUrl: window.location.href
    };

    // Estado global del widget
    let currentUser = null;
    let userPhotos = { local_photos: [], instagram_photos: [] };
    let instagramPhotos = [];

    // Crear el widget
    function createXsmlxWidget() {
        return `
            <div id="${XSMLX_CONFIG.widgetId}" style="
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                display: inline-block;
                margin: 10px;
            ">
                <button onclick="openXsmlxModal('${XSMLX_CONFIG.widgetId}')" style="
                    width: 80px;
                    height: 40px;
                    background: white;
                    border: 2px solid #000;
                    border-radius: 8px;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                    font-weight: 700;
                    font-size: 14px;
                    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                " onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(0, 0, 0, 0.15)'" onmouseout="this.style.transform='none'; this.style.boxShadow='0 2px 4px rgba(0, 0, 0, 0.1)'">
                    <span style="color: #000;">X</span>
                    <span style="color: #ff0000;">S</span>
                    <span style="color: #00ff00;">M</span>
                    <span style="color: #000;">L</span>
                    <span style="color: #ffff00;">X</span>
                </button>
            </div>
        `;
    }

    // Crear el modal con sistema de registro
    function createXsmlxModal() {
        return `
            <div id="xsmlx-modal" style="
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                z-index: 10000;
                backdrop-filter: blur(5px);
            ">
                <div style="
                    position: absolute;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: white;
                    border-radius: 16px;
                    padding: 30px;
                    max-width: 600px;
                    width: 90%;
                    max-height: 85vh;
                    overflow-y: auto;
                    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                ">
                    <button onclick="closeXsmlxModal()" style="
                        position: absolute;
                        top: 15px;
                        right: 20px;
                        background: none;
                        border: none;
                        font-size: 24px;
                        cursor: pointer;
                        color: #999;
                        padding: 5px;
                        border-radius: 50%;
                        width: 30px;
                        height: 30px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    " onmouseover="this.style.backgroundColor='#f0f0f0'" onmouseout="this.style.backgroundColor='transparent'">
                        ×
                    </button>
                    
                    <div id="xsmlx-content">
                        <!-- El contenido se carga dinámicamente -->
                    </div>
                </div>
            </div>
        `;
    }

    // Función para mostrar el formulario de registro
    function showRegistrationForm() {
        const content = document.getElementById('xsmlx-content');
        content.innerHTML = `
            <div style="text-align: center; margin-bottom: 30px;">
                <h2 style="margin: 0 0 10px 0; color: #333; font-size: 24px;">🎨 XSMLX Virtual Try-On</h2>
                <p style="margin: 0; color: #666; font-size: 14px;">Regístrate para guardar tus fotos y personalizar tu experiencia</p>
            </div>
            
            <form id="registration-form" style="display: flex; flex-direction: column; gap: 20px;">
                <div>
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Identificador de usuario</label>
                    <input type="text" id="user-identifier" placeholder="Email, nombre de usuario, etc." required style="
                        width: 100%;
                        padding: 12px;
                        border: 2px solid #e0e0e0;
                        border-radius: 8px;
                        font-size: 14px;
                        box-sizing: border-box;
                    " onfocus="this.style.borderColor='#007bff'" onblur="this.style.borderColor='#e0e0e0'">
                </div>
                
                <div>
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Nombre (opcional)</label>
                    <input type="text" id="user-name" placeholder="Tu nombre" style="
                        width: 100%;
                        padding: 12px;
                        border: 2px solid #e0e0e0;
                        border-radius: 8px;
                        font-size: 14px;
                        box-sizing: border-box;
                    " onfocus="this.style.borderColor='#007bff'" onblur="this.style.borderColor='#e0e0e0'">
                </div>
                
                <button type="submit" style="
                    background: linear-gradient(135deg, #007bff, #0056b3);
                    color: white;
                    border: none;
                    padding: 14px 24px;
                    border-radius: 8px;
                    font-size: 16px;
                    font-weight: 600;
                    cursor: pointer;
                    transition: all 0.3s ease;
                " onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(0, 123, 255, 0.3)'" onmouseout="this.style.transform='none'; this.style.boxShadow='none'">
                    🚀 Continuar
                </button>
            </form>
            
            <div style="text-align: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
                <p style="margin: 0; color: #666; font-size: 12px;">
                    Al continuar, aceptas que tus fotos se guarden para mejorar tu experiencia
                </p>
            </div>
        `;

        // Manejar envío del formulario
        document.getElementById('registration-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            await registerUser();
        });
    }

    // Función para registrar usuario
    async function registerUser() {
        const identifier = document.getElementById('user-identifier').value.trim();
        const name = document.getElementById('user-name').value.trim();
        
        if (!identifier) {
            alert('Por favor, ingresa un identificador de usuario');
            return;
        }

        try {
            const response = await fetch(`${XSMLX_CONFIG.backendUrl}/api/user/register`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    identifier: identifier,
                    user_data: {
                        name: name || null
                    }
                })
            });

            const result = await response.json();
            
            if (result.success) {
                currentUser = result.user_data;
                await loadUserPhotos();
                showMainInterface();
            } else {
                alert('Error al registrar usuario: ' + result.error);
            }
        } catch (error) {
            console.error('Error registrando usuario:', error);
            alert('Error de conexión. Verifica que el backend esté ejecutándose.');
        }
    }

    // Función para cargar fotos del usuario
    async function loadUserPhotos() {
        if (!currentUser) return;

        try {
            const response = await fetch(`${XSMLX_CONFIG.backendUrl}/api/user/${currentUser.id}/photos`);
            const result = await response.json();
            
            if (result.success) {
                userPhotos = result.photos;
                console.log('Fotos del usuario cargadas:', userPhotos);
            }
        } catch (error) {
            console.error('Error cargando fotos del usuario:', error);
        }
    }

    // Función para mostrar la interfaz principal
    function showMainInterface() {
        const content = document.getElementById('xsmlx-content');
        content.innerHTML = `
            <div style="text-align: center; margin-bottom: 30px;">
                <h2 style="margin: 0 0 10px 0; color: #333; font-size: 24px;">🎨 XSMLX Virtual Try-On</h2>
                <p style="margin: 0; color: #666; font-size: 14px;">
                    Hola ${currentUser.name || currentUser.identifier}! 
                    <button onclick="showRegistrationForm()" style="
                        background: none;
                        border: none;
                        color: #007bff;
                        text-decoration: underline;
                        cursor: pointer;
                        font-size: 12px;
                        margin-left: 10px;
                    ">Cambiar usuario</button>
                </p>
            </div>
            
            <!-- Sección de fotos preseleccionadas -->
            <div id="preselected-photos" style="margin-bottom: 30px;">
                <h3 style="margin: 0 0 15px 0; color: #333; font-size: 18px;">📸 Tus fotos guardadas</h3>
                <div id="photos-grid" style="
                    display: grid;
                    grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
                    gap: 10px;
                    margin-bottom: 15px;
                ">
                    <!-- Las fotos se cargarán aquí -->
                </div>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button onclick="showPhotoUpload()" style="
                        background: #28a745;
                        color: white;
                        border: none;
                        padding: 8px 16px;
                        border-radius: 6px;
                        font-size: 12px;
                        cursor: pointer;
                        transition: all 0.3s ease;
                    " onmouseover="this.style.backgroundColor='#218838'" onmouseout="this.style.backgroundColor='#28a745'">
                        📁 Subir nueva foto
                    </button>
                    <button onclick="loadInstagramPhotos()" style="
                        background: #e1306c;
                        color: white;
                        border: none;
                        padding: 8px 16px;
                        border-radius: 6px;
                        font-size: 12px;
                        cursor: pointer;
                        transition: all 0.3s ease;
                    " onmouseover="this.style.backgroundColor='#c13584'" onmouseout="this.style.backgroundColor='#e1306c'">
                        📷 Desde Instagram
                    </button>
                    ${currentUser.instagram_account ? `
                        <button onclick="disconnectInstagram()" style="
                            background: #dc3545;
                            color: white;
                            border: none;
                            padding: 8px 16px;
                            border-radius: 6px;
                            font-size: 12px;
                            cursor: pointer;
                            transition: all 0.3s ease;
                        " onmouseover="this.style.backgroundColor='#c82333'" onmouseout="this.style.backgroundColor='#dc3545'">
                            🔄 Cambiar cuenta
                        </button>
                    ` : ''}
                </div>
            </div>
            
            <!-- Sección de selección de foto actual -->
            <div id="current-photo-section" style="margin-bottom: 30px;">
                <h3 style="margin: 0 0 15px 0; color: #333; font-size: 18px;">📸 Foto seleccionada</h3>
                <div id="selected-photo-preview" style="
                    text-align: center;
                    padding: 20px;
                    border: 2px dashed #e0e0e0;
                    border-radius: 8px;
                    background: #f8f9fa;
                ">
                    <p style="margin: 0; color: #666;">Selecciona una foto de arriba o sube una nueva</p>
                </div>
            </div>
            
            <!-- Sección de imágenes de productos -->
            <div id="product-images-section" style="margin-bottom: 30px;">
                <h3 style="margin: 0 0 15px 0; color: #333; font-size: 18px;">👕 Imágenes de productos encontradas</h3>
                <div id="product-images-grid" style="
                    display: grid;
                    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
                    gap: 10px;
                    margin-bottom: 15px;
                ">
                    <!-- Las imágenes de productos se cargarán aquí -->
                </div>
                <button onclick="extractProductImages()" style="
                    background: #007bff;
                    color: white;
                    border: none;
                    padding: 10px 20px;
                    border-radius: 6px;
                    font-size: 14px;
                    cursor: pointer;
                    transition: all 0.3s ease;
                " onmouseover="this.style.backgroundColor='#0056b3'" onmouseout="this.style.backgroundColor='#007bff'">
                    🔍 Buscar productos en esta página
                </button>
            </div>
            
            <!-- Botón de generar -->
            <div style="text-align: center;">
                <button id="generate-btn" onclick="generateVirtualTryOn()" disabled style="
                    background: #6c757d;
                    color: white;
                    border: none;
                    padding: 15px 30px;
                    border-radius: 8px;
                    font-size: 16px;
                    font-weight: 600;
                    cursor: not-allowed;
                    transition: all 0.3s ease;
                ">
                    🎨 Generar Prueba Virtual
                </button>
            </div>
            
            <!-- Resultado -->
            <div id="result-section" style="margin-top: 30px; display: none;">
                <h3 style="margin: 0 0 15px 0; color: #333; font-size: 18px;">✨ Resultado</h3>
                <div id="result-container" style="text-align: center;">
                    <!-- El resultado se mostrará aquí -->
                </div>
            </div>
        `;

        // Cargar fotos preseleccionadas
        loadPreselectedPhotos();
        
        // Extraer imágenes de productos automáticamente
        extractProductImages();
    }

    // Función para cargar fotos preseleccionadas
    function loadPreselectedPhotos() {
        const grid = document.getElementById('photos-grid');
        grid.innerHTML = '';

        // Mostrar fotos locales
        userPhotos.local_photos.forEach(photo => {
            const photoElement = document.createElement('div');
            photoElement.style.cssText = `
                position: relative;
                aspect-ratio: 1;
                border-radius: 8px;
                overflow: hidden;
                cursor: pointer;
                border: 2px solid transparent;
                transition: all 0.3s ease;
            `;
            photoElement.innerHTML = `
                <img src="${XSMLX_CONFIG.backendUrl}${photo.url}" style="
                    width: 100%;
                    height: 100%;
                    object-fit: cover;
                " onerror="this.style.display='none'">
                <div style="
                    position: absolute;
                    top: 2px;
                    right: 2px;
                    background: rgba(0,0,0,0.7);
                    color: white;
                    border-radius: 50%;
                    width: 20px;
                    height: 20px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 10px;
                ">📁</div>
                <button onclick="deletePhoto('${photo.id}')" style="
                    position: absolute;
                    bottom: 2px;
                    right: 2px;
                    background: rgba(220, 53, 69, 0.8);
                    color: white;
                    border: none;
                    border-radius: 50%;
                    width: 18px;
                    height: 18px;
                    font-size: 10px;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                ">×</button>
            `;
            photoElement.onclick = () => selectPhoto('local', photo);
            photoElement.onmouseover = () => photoElement.style.borderColor = '#007bff';
            photoElement.onmouseout = () => photoElement.style.borderColor = 'transparent';
            grid.appendChild(photoElement);
        });

        // Mostrar fotos de Instagram
        userPhotos.instagram_photos.forEach(photo => {
            const photoElement = document.createElement('div');
            photoElement.style.cssText = `
                position: relative;
                aspect-ratio: 1;
                border-radius: 8px;
                overflow: hidden;
                cursor: pointer;
                border: 2px solid transparent;
                transition: all 0.3s ease;
            `;
            photoElement.innerHTML = `
                <img src="${photo.instagram_url}" style="
                    width: 100%;
                    height: 100%;
                    object-fit: cover;
                " onerror="this.style.display='none'">
                <div style="
                    position: absolute;
                    top: 2px;
                    right: 2px;
                    background: rgba(0,0,0,0.7);
                    color: white;
                    border-radius: 50%;
                    width: 20px;
                    height: 20px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 10px;
                ">📷</div>
                <button onclick="deletePhoto('${photo.id}')" style="
                    position: absolute;
                    bottom: 2px;
                    right: 2px;
                    background: rgba(220, 53, 69, 0.8);
                    color: white;
                    border: none;
                    border-radius: 50%;
                    width: 18px;
                    height: 18px;
                    font-size: 10px;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                ">×</button>
            `;
            photoElement.onclick = () => selectPhoto('instagram', photo);
            photoElement.onmouseover = () => photoElement.style.borderColor = '#007bff';
            photoElement.onmouseout = () => photoElement.style.borderColor = 'transparent';
            grid.appendChild(photoElement);
        });

        if (userPhotos.local_photos.length === 0 && userPhotos.instagram_photos.length === 0) {
            grid.innerHTML = `
                <div style="
                    grid-column: 1 / -1;
                    text-align: center;
                    padding: 20px;
                    color: #666;
                    font-style: italic;
                ">
                    No tienes fotos guardadas aún. ¡Sube tu primera foto!
                </div>
            `;
        }
    }

    // Función para seleccionar una foto
    function selectPhoto(type, photo) {
        const preview = document.getElementById('selected-photo-preview');
        const generateBtn = document.getElementById('generate-btn');
        
        if (type === 'local') {
            preview.innerHTML = `
                <img src="${XSMLX_CONFIG.backendUrl}${photo.url}" style="
                    max-width: 200px;
                    max-height: 200px;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                ">
                <p style="margin: 10px 0 0 0; color: #333; font-weight: 600;">Foto local seleccionada</p>
            `;
        } else if (type === 'instagram') {
            preview.innerHTML = `
                <img src="${photo.instagram_url}" style="
                    max-width: 200px;
                    max-height: 200px;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                ">
                <p style="margin: 10px 0 0 0; color: #333; font-weight: 600;">Foto de Instagram seleccionada</p>
            `;
        }
        
        // Habilitar botón de generar si hay productos
        const productGrid = document.getElementById('product-images-grid');
        if (productGrid.children.length > 0) {
            generateBtn.disabled = false;
            generateBtn.style.background = '#28a745';
            generateBtn.style.cursor = 'pointer';
            generateBtn.onmouseover = () => {
                generateBtn.style.backgroundColor = '#218838';
                generateBtn.style.transform = 'translateY(-1px)';
            };
            generateBtn.onmouseout = () => {
                generateBtn.style.backgroundColor = '#28a745';
                generateBtn.style.transform = 'none';
            };
        }
        
        // Guardar selección
        window.selectedPhoto = { type, photo };
    }

    // Función para eliminar foto
    async function deletePhoto(photoId) {
        if (!confirm('¿Estás seguro de que quieres eliminar esta foto?')) return;
        
        try {
            const response = await fetch(`${XSMLX_CONFIG.backendUrl}/api/user/${currentUser.id}/photos/${photoId}`, {
                method: 'DELETE'
            });
            
            const result = await response.json();
            
            if (result.success) {
                await loadUserPhotos();
                loadPreselectedPhotos();
                alert('Foto eliminada exitosamente');
            } else {
                alert('Error al eliminar foto: ' + result.error);
            }
        } catch (error) {
            console.error('Error eliminando foto:', error);
            alert('Error de conexión al eliminar foto');
        }
    }

    // Función para mostrar subida de foto
    function showPhotoUpload() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        input.onchange = async (e) => {
            const file = e.target.files[0];
            if (file) {
                await uploadPhoto(file);
            }
        };
        input.click();
    }

    // Función para subir foto
    async function uploadPhoto(file) {
        try {
            const formData = new FormData();
            formData.append('photo', file);
            
            const response = await fetch(`${XSMLX_CONFIG.backendUrl}/api/user/${currentUser.id}/photos/local`, {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (result.success) {
                await loadUserPhotos();
                loadPreselectedPhotos();
                alert('Foto subida exitosamente');
            } else {
                alert('Error al subir foto: ' + result.error);
            }
        } catch (error) {
            console.error('Error subiendo foto:', error);
            alert('Error de conexión al subir foto');
        }
    }

    // Función para cargar fotos de Instagram
    async function loadInstagramPhotos() {
        try {
            const response = await fetch(`${XSMLX_CONFIG.backendUrl}/api/instagram-photos`);
            const result = await response.json();
            
            if (result.success) {
                instagramPhotos = result.photos;
                showInstagramPhotoSelector();
            } else {
                alert('Error cargando fotos de Instagram: ' + result.error);
            }
        } catch (error) {
            console.error('Error cargando fotos de Instagram:', error);
            alert('Error de conexión. Verifica que el backend esté ejecutándose y configurado con Instagram API');
        }
    }

    // Función para mostrar selector de fotos de Instagram
    function showInstagramPhotoSelector() {
        const content = document.getElementById('xsmlx-content');
        content.innerHTML = `
            <div style="text-align: center; margin-bottom: 30px;">
                <h2 style="margin: 0 0 10px 0; color: #333; font-size: 24px;">📷 Seleccionar foto de Instagram</h2>
                <button onclick="showMainInterface()" style="
                    background: #6c757d;
                    color: white;
                    border: none;
                    padding: 8px 16px;
                    border-radius: 6px;
                    font-size: 12px;
                    cursor: pointer;
                    margin-bottom: 20px;
                ">← Volver</button>
            </div>
            
            <div style="
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
                gap: 15px;
                margin-bottom: 30px;
            ">
                ${instagramPhotos.map(photo => `
                    <div onclick="selectInstagramPhoto('${photo.id}')" style="
                        aspect-ratio: 1;
                        border-radius: 8px;
                        overflow: hidden;
                        cursor: pointer;
                        border: 2px solid transparent;
                        transition: all 0.3s ease;
                        position: relative;
                    " onmouseover="this.style.borderColor='#007bff'" onmouseout="this.style.borderColor='transparent'">
                        <img src="${photo.thumbnail}" style="
                            width: 100%;
                            height: 100%;
                            object-fit: cover;
                        ">
                        <div style="
                            position: absolute;
                            bottom: 0;
                            left: 0;
                            right: 0;
                            background: linear-gradient(transparent, rgba(0,0,0,0.7));
                            color: white;
                            padding: 8px;
                            font-size: 10px;
                            text-align: center;
                        ">
                            ${photo.caption}
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
    }

    // Función para seleccionar foto de Instagram
    async function selectInstagramPhoto(photoId) {
        const photo = instagramPhotos.find(p => p.id === photoId);
        if (!photo) return;
        
        try {
            // Guardar foto de Instagram
            const response = await fetch(`${XSMLX_CONFIG.backendUrl}/api/user/${currentUser.id}/photos/instagram`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    instagram_data: photo
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                await loadUserPhotos();
                showMainInterface();
                alert('Foto de Instagram guardada exitosamente');
            } else {
                alert('Error al guardar foto de Instagram: ' + result.error);
            }
        } catch (error) {
            console.error('Error guardando foto de Instagram:', error);
            alert('Error de conexión al guardar foto');
        }
    }

    // Función para desconectar Instagram
    async function disconnectInstagram() {
        if (!confirm('¿Estás seguro de que quieres desconectar tu cuenta de Instagram?')) return;
        
        try {
            const response = await fetch(`${XSMLX_CONFIG.backendUrl}/api/user/${currentUser.id}/instagram/disconnect`, {
                method: 'POST'
            });
            
            const result = await response.json();
            
            if (result.success) {
                currentUser.instagram_account = null;
                showMainInterface();
                alert('Cuenta de Instagram desconectada exitosamente');
            } else {
                alert('Error al desconectar Instagram: ' + result.error);
            }
        } catch (error) {
            console.error('Error desconectando Instagram:', error);
            alert('Error de conexión al desconectar Instagram');
        }
    }

    // Función para extraer imágenes de productos
    async function extractProductImages() {
        const grid = document.getElementById('product-images-grid');
        grid.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 20px; color: #666;">🔍 Buscando productos...</div>';
        
        try {
            const response = await fetch(`${XSMLX_CONFIG.backendUrl}/api/process`, {
                method: 'POST',
                body: new FormData() // Solo para obtener las imágenes, no procesar
            });
            
            // Simular extracción de imágenes (en una implementación real, esto sería un endpoint separado)
            const mockImages = [
                'https://via.placeholder.com/150x150/ff6b6b/ffffff?text=Producto+1',
                'https://via.placeholder.com/150x150/4ecdc4/ffffff?text=Producto+2',
                'https://via.placeholder.com/150x150/45b7d1/ffffff?text=Producto+3',
                'https://via.placeholder.com/150x150/96ceb4/ffffff?text=Producto+4',
                'https://via.placeholder.com/150x150/ffeaa7/ffffff?text=Producto+5',
                'https://via.placeholder.com/150x150/dda0dd/ffffff?text=Producto+6'
            ];
            
            grid.innerHTML = '';
            mockImages.forEach((imgUrl, index) => {
                const imgElement = document.createElement('div');
                imgElement.style.cssText = `
                    aspect-ratio: 1;
                    border-radius: 8px;
                    overflow: hidden;
                    cursor: pointer;
                    border: 2px solid transparent;
                    transition: all 0.3s ease;
                `;
                imgElement.innerHTML = `
                    <img src="${imgUrl}" style="
                        width: 100%;
                        height: 100%;
                        object-fit: cover;
                    ">
                `;
                imgElement.onclick = () => selectProductImage(imgUrl, index);
                imgElement.onmouseover = () => imgElement.style.borderColor = '#28a745';
                imgElement.onmouseout = () => imgElement.style.borderColor = 'transparent';
                grid.appendChild(imgElement);
            });
            
        } catch (error) {
            console.error('Error extrayendo imágenes de productos:', error);
            grid.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 20px; color: #dc3545;">❌ Error extrayendo imágenes de productos</div>';
        }
    }

    // Función para seleccionar imagen de producto
    function selectProductImage(imageUrl, index) {
        window.selectedProductImage = { url: imageUrl, index };
        
        // Actualizar visualmente la selección
        const grid = document.getElementById('product-images-grid');
        Array.from(grid.children).forEach((child, i) => {
            if (i === index) {
                child.style.borderColor = '#28a745';
                child.style.borderWidth = '3px';
            } else {
                child.style.borderColor = 'transparent';
                child.style.borderWidth = '2px';
            }
        });
        
        // Habilitar botón de generar si hay foto de usuario
        const generateBtn = document.getElementById('generate-btn');
        if (window.selectedPhoto) {
            generateBtn.disabled = false;
            generateBtn.style.background = '#28a745';
            generateBtn.style.cursor = 'pointer';
            generateBtn.onmouseover = () => {
                generateBtn.style.backgroundColor = '#218838';
                generateBtn.style.transform = 'translateY(-1px)';
            };
            generateBtn.onmouseout = () => {
                generateBtn.style.backgroundColor = '#28a745';
                generateBtn.style.transform = 'none';
            };
        }
    }

    // Función para generar virtual try-on
    async function generateVirtualTryOn() {
        if (!window.selectedPhoto || !window.selectedProductImage) {
            alert('Por favor, selecciona una foto tuya y una imagen de producto');
            return;
        }
        
        const generateBtn = document.getElementById('generate-btn');
        const resultSection = document.getElementById('result-section');
        
        generateBtn.disabled = true;
        generateBtn.innerHTML = '🎨 Generando...';
        generateBtn.style.background = '#6c757d';
        resultSection.style.display = 'none';
        
        try {
            const formData = new FormData();
            formData.append('page_url', XSMLX_CONFIG.currentPageUrl);
            
            if (window.selectedPhoto.type === 'local') {
                formData.append('photo_source', 'upload');
                // En una implementación real, necesitarías obtener el archivo de la foto
                // Por ahora, usamos la URL de la foto guardada
                formData.append('user_photo_url', `${XSMLX_CONFIG.backendUrl}${window.selectedPhoto.photo.url}`);
            } else if (window.selectedPhoto.type === 'instagram') {
                formData.append('photo_source', 'instagram');
                formData.append('instagram_photo_url', window.selectedPhoto.photo.instagram_url);
                formData.append('instagram_photo_id', window.selectedPhoto.photo.instagram_id);
            }
            
            const response = await fetch(`${XSMLX_CONFIG.backendUrl}/api/process`, {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (result.success) {
                showResult(result.image_url);
            } else {
                alert('Error generando imagen: ' + result.error);
            }
        } catch (error) {
            console.error('Error generando virtual try-on:', error);
            alert('Error de conexión al generar imagen');
        } finally {
            generateBtn.disabled = false;
            generateBtn.innerHTML = '🎨 Generar Prueba Virtual';
            generateBtn.style.background = '#28a745';
        }
    }

    // Función para mostrar resultado
    function showResult(imageUrl) {
        const resultSection = document.getElementById('result-section');
        const resultContainer = document.getElementById('result-container');
        
        // Convertir URL relativa a absoluta si es necesario
        const fullImageUrl = imageUrl.startsWith('/') ? `${XSMLX_CONFIG.backendUrl}${imageUrl}` : imageUrl;
        
        resultContainer.innerHTML = `
            <img src="${fullImageUrl}" style="
                max-width: 100%;
                max-height: 400px;
                border-radius: 12px;
                box-shadow: 0 8px 24px rgba(0,0,0,0.15);
                margin-bottom: 20px;
            " onerror="this.style.display='none'; this.nextElementSibling.style.display='block'">
            <div style="display: none; color: #dc3545; padding: 20px;">
                ❌ Error cargando imagen resultante
            </div>
            <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                <a href="${fullImageUrl}" download="virtual-try-on-result.png" style="
                    background: #28a745;
                    color: white;
                    text-decoration: none;
                    padding: 10px 20px;
                    border-radius: 6px;
                    font-size: 14px;
                    font-weight: 600;
                    transition: all 0.3s ease;
                " onmouseover="this.style.backgroundColor='#218838'" onmouseout="this.style.backgroundColor='#28a745'">
                    💾 Descargar
                </a>
                <button onclick="generateVirtualTryOn()" style="
                    background: #007bff;
                    color: white;
                    border: none;
                    padding: 10px 20px;
                    border-radius: 6px;
                    font-size: 14px;
                    font-weight: 600;
                    cursor: pointer;
                    transition: all 0.3s ease;
                " onmouseover="this.style.backgroundColor='#0056b3'" onmouseout="this.style.backgroundColor='#007bff'">
                    🔄 Generar otra
                </button>
            </div>
        `;
        
        resultSection.style.display = 'block';
        resultSection.scrollIntoView({ behavior: 'smooth' });
    }

    // Funciones globales para el modal
    window.openXsmlxModal = function(widgetId) {
        const modal = document.getElementById('xsmlx-modal');
        if (!modal) {
            document.body.insertAdjacentHTML('beforeend', createXsmlxModal());
        }
        
        document.getElementById('xsmlx-modal').style.display = 'block';
        document.body.style.overflow = 'hidden';
        
        // Mostrar formulario de registro si no hay usuario
        if (!currentUser) {
            showRegistrationForm();
        } else {
            showMainInterface();
        }
    };

    window.closeXsmlxModal = function() {
        const modal = document.getElementById('xsmlx-modal');
        if (modal) {
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }
    };

    // Cerrar modal al hacer clic fuera
    document.addEventListener('click', function(e) {
        const modal = document.getElementById('xsmlx-modal');
        if (modal && e.target === modal) {
            closeXsmlxModal();
        }
    });

    // Cerrar modal con tecla Escape
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeXsmlxModal();
        }
    });

    // Inicializar widget cuando el DOM esté listo
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            document.body.insertAdjacentHTML('beforeend', createXsmlxWidget());
        });
    } else {
        document.body.insertAdjacentHTML('beforeend', createXsmlxWidget());
    }

})();
</script>
</body>
</html>
